<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Wild Rydes</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://js.arcgis.com/4.6/esri/css/main.css">
  <link rel="stylesheet" href="css/ride.css">
  <link rel="stylesheet" href="css/message.css">
</head>
<body>

  <div class="info panel panel-default">
    <div class="panel-heading">
      <button id="request" class="btn btn-primary" disabled>Set pickup</button>
      <div class="dropdown pull-right">
        <button class="btn dropdown-toggle" data-toggle="dropdown">Account <span class="caret"></span></button>
        <ul class="dropdown-menu">
          <li><a id="signOut" href="#">Sign out</a></li>
        </ul>
      </div>
    </div>
    <div class="panel-body">
      <ol id="updates">
        <li>Click the map to set your pickup location.</li>
      </ol>
    </div>
  </div>

  <div id="main">
    <div id="map"></div>
  </div>

  <!-- Load dependencies -->
  <script src="js/vendor/jquery-3.1.0.js"></script>
  <script src="js/vendor/bootstrap.min.js"></script>
  <script src="https://js.arcgis.com/4.6/"></script>
  <script src="js/config.js"></script>
  <script src="js/esri-map.js"></script>

  <script>
    const authToken = 'dummy-token'; // Bypass auth for testing

    function requestUnicorn(pickupLocation) {
      $.ajax({
        method: 'POST',
        url: _config.api.invokeUrl + '/ride',
        headers: {
          Authorization: authToken
        },
        data: JSON.stringify({
          PickupLocation: {
            Latitude: pickupLocation.latitude,
            Longitude: pickupLocation.longitude
          }
        }),
        contentType: 'application/json',
        success: function (result) {
          $('#updates').append('<li>Unicorn is on the way: ' + result.Unicorn.Name + '</li>');
        },
        error: function (err) {
          alert('API Error: ' + err.responseText);
        }
      });
    }

    function enableRequestButton() {
      $('#request').text('Request Unicorn');
      $('#request').prop('disabled', false);
    }

    $(function () {
      $('#main').show();

      if (typeof initializeMap === 'function') {
        initializeMap();
      }

      $(WildRydes.map).on('pickupChange', function () {
        enableRequestButton();
      });

      $('#request').click(function (e) {
        e.preventDefault();
        const loc = WildRydes.map.selectedPoint;
        if (loc) {
          requestUnicorn(loc);
        } else {
          alert('Please select a pickup location first.');
        }
      });
    });
  </script>

</body>
</html>
